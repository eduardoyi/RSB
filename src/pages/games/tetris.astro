---
import DesktopLayout from '../../layouts/DesktopLayout.astro';
import Window from '../../components/Window.astro';
import '../../styles/games.css';
---
<DesktopLayout title="Tetris — Real Serious Business">
  <Window title="Tetris" icon="/icons/win98/joystick_alt.ico" path="/games/tetris" backHref="/games" defaultWidth={540} defaultHeight={680} defaultX={80} defaultY={20} noBodyScroll={true}>
    <div style="background:silver;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;padding:6px;gap:8px;">
      <div style="box-shadow:inset 1px 1px #808080,inset -1px -1px #fff,inset 2px 2px #404040,inset -2px -2px #dfdfdf;flex-shrink:0;">
        <div id="root" style="text-align:center;"></div>
      </div>

      <!-- D-pad controls — only visible on touch devices -->
      <div class="tetris-mobile-controls" aria-label="Game controls">
        <div class="tetris-dpad-row">
          <button class="tetris-btn" id="tet-rotate" aria-label="Rotate">↺</button>
          <button class="tetris-btn tetris-btn-wide" id="tet-pause" aria-label="Start / Pause">⏸</button>
        </div>
        <div class="tetris-dpad-row">
          <button class="tetris-btn" id="tet-left" aria-label="Left">◀</button>
          <button class="tetris-btn" id="tet-down" aria-label="Drop">▼</button>
          <button class="tetris-btn" id="tet-right" aria-label="Right">▶</button>
        </div>
      </div>
    </div>
  </Window>
</DesktopLayout>
<script src="/games/tetris/tetris.js" is:inline></script>
<script is:inline>
  (function () {
    function pressKey(keyCode) {
      document.dispatchEvent(new KeyboardEvent('keydown', { keyCode: keyCode, which: keyCode, bubbles: true }));
    }
    function releaseKey(keyCode) {
      document.dispatchEvent(new KeyboardEvent('keyup', { keyCode: keyCode, which: keyCode, bubbles: true }));
    }

    var downInterval = null;

    var btns = {
      'tet-rotate': { down: function() { pressKey(38); } },
      'tet-left':   { down: function() { pressKey(37); } },
      'tet-right':  { down: function() { pressKey(39); } },
      'tet-pause':  { down: function() { pressKey(13); } },
      'tet-down': {
        down: function() {
          pressKey(40);
          downInterval = setInterval(function() { pressKey(40); }, 80);
        },
        up: function() {
          clearInterval(downInterval);
          downInterval = null;
          releaseKey(40);
        }
      }
    };

    Object.keys(btns).forEach(function (id) {
      var el = document.getElementById(id);
      var btn = btns[id];
      if (!el) return;
      el.addEventListener('touchstart', function (e) {
        e.preventDefault();
        btn.down && btn.down();
      }, { passive: false });
      el.addEventListener('touchend', function (e) {
        e.preventDefault();
        btn.up && btn.up();
      }, { passive: false });
    });
  })();
</script>
