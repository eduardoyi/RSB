---
import DesktopLayout from '../../layouts/DesktopLayout.astro';
import Window from '../../components/Window.astro';
import '../../styles/games.css';
---
<DesktopLayout title="Minesweeper â€” Real Serious Business">
  <Window title="Minesweeper" icon="/icons/win98/minesweeper.ico" path="/games/minesweeper" backHref="/games" defaultWidth={320} defaultHeight={440} defaultX={80} defaultY={30} noBodyScroll={true}>
    <div class="ms-wrapper">

      <!-- Win98-style difficulty toolbar -->
      <div class="ms-toolbar" role="toolbar" aria-label="Difficulty">
        <button class="ms-diff active" data-cols="9"  data-rows="9"  data-mines="10">Beginner</button>
        <button class="ms-diff"       data-cols="16" data-rows="16" data-mines="40">Intermediate</button>
        <button class="ms-diff"       data-cols="30" data-rows="16" data-mines="99">Expert</button>
        <!-- Flag mode toggle â€” useful on touch where right-click isn't available -->
        <label class="ms-flag-label" title="Tap to flag instead of reveal">
          <input type="checkbox" id="ms-flag-toggle"> ðŸš© Flag
        </label>
      </div>

      <!-- Canvas â€” scrollable so Expert (920px wide) fits -->
      <div class="ms-canvas-wrap">
        <canvas id="jsminesweeper" width="290" height="350"></canvas>
      </div>

      <!-- Win98 dialog â€” replaces the native alert() on win/lose -->
      <div id="ms-result" class="ms-result" style="display:none">
        <div class="ms-result-titlebar">Minesweeper</div>
        <div class="ms-result-body">
          <p id="ms-result-msg"></p>
          <button onclick="document.getElementById('ms-result').style.display='none'">OK</button>
        </div>
      </div>

    </div>
  </Window>
</DesktopLayout>

<script src="/games/minesweeper/minesweeper.js" is:inline></script>
<script is:inline>
  // Replace native alert with a Win98 dialog
  window.alert = function (msg) {
    document.getElementById('ms-result-msg').textContent = msg;
    document.getElementById('ms-result').style.display = 'flex';
  };

  window.addEventListener('load', function () {
    init();
    jsminesweeper(9, 9, 10);

    // Difficulty buttons
    document.querySelectorAll('.ms-diff').forEach(function (btn) {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.ms-diff').forEach(function (b) { b.classList.remove('active'); });
        this.classList.add('active');

        var cols  = parseInt(this.dataset.cols,  10);
        var rows  = parseInt(this.dataset.rows,  10);
        var mines = parseInt(this.dataset.mines, 10);

        var canvas = document.getElementById('jsminesweeper');
        canvas.width  = 30 * cols + 20;
        canvas.height = 30 * rows + 80;

        var wEl = document.querySelector('.w98-window[data-window-path="/games/minesweeper"]');
        if (wEl) {
          wEl.style.width  = (canvas.width  + 32) + 'px';
          wEl.style.height = (canvas.height + 90) + 'px';
        }

        clearInterval(gametimer);
        gametimer     = null;
        timer         = 0;
        end           = false;
        win           = false;
        numberofmines = 0;

        jsminesweeper(cols, rows, mines);
      });
    });

    // Touch-to-flag: when flag mode is on, a tap flags the cell instead of revealing it
    var msCanvas = document.getElementById('jsminesweeper');
    msCanvas.addEventListener('touchend', function (e) {
      var flagMode = document.getElementById('ms-flag-toggle').checked;
      if (!flagMode) return; // let the default tap-as-click handle reveal
      e.preventDefault();
      var touch = e.changedTouches[0];
      var rect  = msCanvas.getBoundingClientRect();
      var i = Math.floor((touch.clientX - rect.left  - xo) / c);
      var j = Math.floor((touch.clientY - rect.top   - yo) / c);
      if (i >= 0 && j >= 0 && i < size.w && j < size.h) {
        if (gametimer === null && !end) {
          gametimer = setInterval(function () {
            timer++;
            win = checkGame();
            if (win) { end = true; }
            updateHeader();
          }, 1000);
        }
        var mine = mines[i][j];
        if (!mine.isDown) {
          if (numberofmines !== 0 || mine.isFlagged) {
            mine.isFlagged = !mine.isFlagged;
          }
        }
        update();
      }
    }, { passive: false });
  });
</script>
