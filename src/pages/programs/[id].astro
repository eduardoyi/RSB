---
import DesktopLayout from '../../layouts/DesktopLayout.astro';
import Window from '../../components/Window.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const programs = await getCollection('programs');
  return programs.map((prog) => ({
    params: { id: prog.data.id },
    props: { prog },
  }));
}

const { prog } = Astro.props;
---
<DesktopLayout title={`${prog.data.title} â€” Real Serious Business`} description={prog.data.description}>
  <Window
    title={prog.data.title}
    path={`/programs/${prog.data.id}`}
    backHref="/programs"
    defaultWidth={480}
    defaultHeight={400}
    defaultX={100}
    defaultY={60}
  >
    <div style="display:flex;flex-direction:column;align-items:center;padding:24px;gap:16px;height:100%;">
      {prog.data.splash_image && (
        <img
          src={prog.data.splash_image}
          alt={prog.data.title}
          style="max-width:200px;max-height:120px;object-fit:contain;image-rendering:pixelated;"
        />
      )}
      <div style="text-align:center;">
        <h2 style="margin:0 0 4px;">{prog.data.title}</h2>
        <p style="margin:0;color:#666;font-size:12px;">Version {prog.data.version}</p>
      </div>
      <p style="text-align:center;max-width:320px;font-size:13px;">{prog.data.description}</p>

      <!-- Fake loading bar -->
      <div class="progress-bar" style="width:280px;margin-top:8px;">
        <div class="progress-bar-fill" id="loading-bar" style="width:0%;transition:width 0.05s linear;"></div>
      </div>
      <p id="loading-label" style="font-size:11px;color:#444;margin:0;">Loading...</p>

      <a
        href={prog.data.launch_url}
        id="launch-btn"
        class="button"
        style="display:none;margin-top:8px;"
        target="_blank"
        rel="noopener noreferrer"
      >
        Launch
      </a>
    </div>
  </Window>
</DesktopLayout>

<script>
  const bar = document.getElementById('loading-bar') as HTMLElement | null;
  const label = document.getElementById('loading-label') as HTMLElement | null;
  const btn = document.getElementById('launch-btn') as HTMLElement | null;

  if (bar && label && btn) {
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 8 + 2;
      if (progress >= 100) {
        progress = 100;
        clearInterval(interval);
        label.textContent = 'Ready.';
        btn.style.display = 'inline-block';
      }
      bar.style.width = progress + '%';
      if (progress < 100) {
        label.textContent = `Loading... ${Math.floor(progress)}%`;
      }
    }, 80);
  }
</script>
